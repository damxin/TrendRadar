#!/bin/bash

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  TrendRadar MCP Server (HTTP æ¨¡å¼)    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# 1. æ£€æŸ¥ uv å‘½ä»¤æ˜¯å¦å®‰è£…
if ! command -v uv &> /dev/null; then
    echo "ğŸ” [ä¿¡æ¯] æœªæ‰¾åˆ° uv å‘½ä»¤ï¼Œæ­£åœ¨å®‰è£…..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    # å°è¯•å°† uv è·¯å¾„åŠ å…¥å½“å‰ PATH
    export PATH="$HOME/.cargo/bin:$PATH"
    export PATH="$HOME/.local/bin:$PATH"
fi

# 2. åˆ›å»º/åŒæ­¥è™šæ‹Ÿç¯å¢ƒ
echo "ğŸ› ï¸ [ç¯å¢ƒ] æ­£åœ¨å‡†å¤‡è™šæ‹Ÿç¯å¢ƒ..."
uv venv

# 3. å®‰è£…é¡¹ç›®ä¾èµ–
echo "ğŸ“¦ [ä¾èµ–] æ­£åœ¨å®‰è£…å½“å‰é¡¹ç›®..."
uv pip install .

# æ­¤å¤„æ·»åŠ ï¼šè¿è¡Œçˆ¬è™«è·å–æœ€æ–°æ•°æ® (å¯é€‰)
echo "ğŸ” [çˆ¬è™«] æ­£åœ¨è·å–æœ€æ–°çƒ­ç‚¹æ–°é—»..."
uv run trendradar

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              TrendRadar æœåŠ¡å¯åŠ¨ä¸­                       â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  [MCP æœåŠ¡]  http://0.0.0.0:13333/mcp (ä¾› AI å®¢æˆ·ç«¯è°ƒç”¨)  â•‘"
echo "â•‘  [ç½‘é¡µæœåŠ¡]  http://0.0.0.0:18081     (ç”¨äºæµè§ˆå™¨è®¿é—®)    â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘  æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡                                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# å®šä¹‰æ¸…ç†å‡½æ•°ï¼Œåœ¨è„šæœ¬é€€å‡ºæ—¶ç»ˆæ­¢åå°è¿›ç¨‹
cleanup() {
    echo ""
    echo "ğŸ›‘ æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡..."
    if [ ! -z "$MCP_PID" ]; then
        kill $MCP_PID 2>/dev/null
        echo "   MCP æœåŠ¡å·²åœæ­¢ (PID: $MCP_PID)"
    fi
    echo "   æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
    exit 0
}

# æ•è· Ctrl+C ä¿¡å·
trap cleanup SIGINT SIGTERM

# 4. åå°å¯åŠ¨ MCP æœåŠ¡ (ç«¯å£ 3333)
echo "ğŸš€ [MCP] æ­£åœ¨å¯åŠ¨ MCP æœåŠ¡..."
uv run python -m mcp_server.server --transport http --host 0.0.0.0 --port 13333 &
MCP_PID=$!
echo "   MCP æœåŠ¡å·²å¯åŠ¨ (PID: $MCP_PID)"

# ç­‰å¾… MCP æœåŠ¡å¯åŠ¨
sleep 2

# 5. å‰å°å¯åŠ¨ Web æœåŠ¡å™¨ (ç«¯å£ 8080)
echo "ğŸŒ [Web] æ­£åœ¨å¯åŠ¨ç½‘é¡µæœåŠ¡..."
uv run python start_http_server.py 18081
